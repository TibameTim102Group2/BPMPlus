@model IEnumerable<BPMPlus.Models.Form>
@section Style {
    <style>
        #mainWrapper {
            background-color: #cfecff;
        }

        #mainpart {
            padding: 30px 40px;
        }

        .selectbtn {
            background-color: #458bfc;
            color: white;
            font-weight: bold;
        }

        .content .connectedSortable option {
            background-color: white;
            color: #458bfc;
            font-weight: bold;
        }

        .clearfix button {
            background-color: #458bfc;
        }

        .table-bordered {
            text-align: center;
        }

        ::placeholder {
            color: aliceblue;
        }
    </style>
    <link rel="stylesheet" href="~/font-awesome/css/all.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
}



<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-3 mx-4 justify-content-between">
            <h1 class="m-0">查詢工單</h1>
        </div>
    </div>
</div>



<div class="container-fluid">
    <br>
    <br>
    <div class="row">
        <section class="connectedSortable">

            <div class="accordion" id="accordionExample">
                <div id="mainpart" class="card">
                    <div class="row justify-content-between mb-3">


                        <div class="col-2 d-flex justify-content-center">
                            <input type="text" class="btn btn-primary fID" style="outline:none ;width:80%" placeholder="請填工單編號" />
                        </div>
                        <div class="col-2 d-flex justify-content-center">
                            <select class="form-select selectbtn selectUserName" asp-items="ViewBag.UserId">
                                <option value="" disabled selected>申請者</option>
                            </select>
                        </div>
                        <div class="col-2 d-flex justify-content-center">
                            <select class="form-select selectbtn selectCategoryId" asp-items="ViewBag.CategoryId">
                                <option value="" disabled selected>需求類別</option>
                            </select>
                        </div>


                        <div class="col-2 d-flex justify-content-center">
                            <select class="form-select selectbtn selectProjectId" asp-items="ViewBag.ProjectId">
                                <option value="" disabled selected>專案名稱</option>
                            </select>
                        </div>

                        <div class="col-2 d-flex justify-content-center">
                            <input type="date" class="btn btn-primary createddate" style="outline:none" min="2024-01-01" />
                        </div>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">單號</th>
                                <th scope="col">部門</th>
                                <th scope="col">姓名</th>
                                <th scope="col">需求項目類別</th>
                                <th scope="col">專案名稱</th>
                                <th scope="col">狀態</th>
                                <th scope="col">建立時間</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach (var item in Model)
                            {

                                <tr>
                                    <td>
                                        <a asp-area="" asp-controller="FormDetails" asp-action="Index" asp-route-id="@item.FormId">
                                            @Html.DisplayFor(modelItem => item.FormId)
                                        </a>

                                    </td>
                                    <td>
                                        @{
                                            var dapartmentname = ViewBag.Departments[item.DepartmentId];

                                        }
                                        @dapartmentname
                                    </td>
                                    <td>
                                        @{
                                            var userName = ViewBag.UserName[item.UserId];

                                        }
                                        @userName
                                    </td>
                                    <td>
                                        @{
                                            var category = ViewBag.category[item.CategoryId];

                                        }
                                        @category
                                    </td>
                                    <td>
                                        @{
                                            string projectName;
                                            if(item.ProjectId == null)
                                            {
                                                projectName = null;
                                            }
                                            else projectName = ViewBag.ProjectName[item.ProjectId];

                                        }
                                        @projectName
                                    </td>
                                    <td>
                                        @{
                                            var process = ViewBag.process[item.ProcessNodeId];
                                            var situation = ViewBag.situation[process];

                                        }
                                        @situation
                                    </td>
                                    <td>
                                        @item.Date.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                    </td>



                                </tr>
                            }
                        </tbody>
                    </table>


                </div>


            </div>
        </section>
    </div>

</div>

<!-- /.container-fluid -->
@section Scripts {
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            $('table').DataTable({
                paging: true,
                ordering: true

            });
        });
        //透過表單編號篩選
        $(".fID").change(function (e) {
            var inputId = $(this).val();
            $(".fID").val(""); //清除內部值
            $.ajax({
                url: '@Url.Action("SearchByFormId", "QueryForms")',
                type: 'GET',
                data: { formId: inputId },
                success: function (response) {
                    if (response.data) {
                        var item = response.data;
                        console.log(item);
                        $('table').DataTable().destroy();
                        //重新加入新的標籤
                        // $("tbody").empty();
                         $("tbody").empty();
                        var newRow = `<tr>
                                                    <td>
                                                        <a href="/FormDetails/Index/${item.formId}">
                                                            ${item.formId}
                                                        </a>
                                                    </td>
                                                    <td>${item.departmentName}</td>
                                                    <td>${item.userName}</td>
                                                    <td>${item.categoryDescription}</td>
                                                    <td>${item.projectName}</td>
                                                    <td>${item.situation}</td>
                                                    <td>${item.createdTime}</td>
                                                </tr>`;
                        $("tbody").append(newRow);
                        $('table').DataTable({
                            paging: true,
                            ordering: true,
                        });

                    } else {
                        alert(response.message || "連接失敗，請重新輸入");
                    }
                },
            });
        });
        //透過UserId篩選
        $(".selectUserName").change(function (e) {
            var value = this.value;
            $.ajax({
                url: '@Url.Action("UserName", "QueryForms")',
                type: 'GET',
                data: { userId: value },
                success: function (response) {
                    if (response.success) {
                        let model = response.data;
                        $('table').DataTable().destroy();
                        $("tbody").empty();
                        model.findForm.forEach(function (item) {
                            var newRow = `<tr>
                                                        <td>
                                                            <a href="/FormDetails/Index/${item.formId}">
                                                                ${item.formId}
                                                            </a>
                                                        </td>
                                                        <td>${model.departments[item.departmentId]}</td>
                                                        <td>${model.userName[item.userId]}</td>
                                                        <td>${model.category[item.categoryId]}</td>
                                                        <td>${model.projectName[item.projectId]}</td>
                                                        <td>${model.userActivity[model.processNodes[item.processNodeId]]}</td>
                                                        <td>${item.createdTime}</td>
                                                    </tr>`;
                            $("tbody").append(newRow);

                        });
                        $('table').DataTable({
                            paging: true,
                            ordering: true,
                        });

                    } else {
                        alert(response.message);
                    }

                },
                error: function (response) {
                    alert("搜尋失敗")
                }
            })

        });
        //透過categoryId 篩選
        $(".selectCategoryId").change(function () {
            var value = this.value;
            $.ajax({
                url: '@Url.Action("Category", "QueryForms")',
                type: 'GET',
                data: { categoryId: value },
                success: function (response) {
                    if (response.success) {
                        let model = response.data;
                        $('table').DataTable().destroy();
                        $("tbody").empty();
                        model.findForm.forEach(function (item) {
                            var newRow = `<tr>
                                                                <td>
                                                                    <a href="/FormDetails/Index/${item.formId}">
                                                                        ${item.formId}
                                                                    </a>
                                                                </td>
                                                                <td>${model.departments[item.departmentId]}</td>
                                                                <td>${model.userName[item.userId]}</td>
                                                                <td>${model.category[item.categoryId]}</td>
                                                                <td>${model.projectName[item.projectId]}</td>
                                                                <td>${model.userActivity[model.processNodes[item.processNodeId]]}</td>
                                                                <td>${item.createdTime}</td>
                                                            </tr>`;
                            $("tbody").append(newRow);

                        });
                        $('table').DataTable({
                            paging: true,
                            ordering: true,
                        });
                    } else {
                        alert(response.message);
                    }

                },
                error: function (response) {
                    alert("搜尋失敗")
                }
            })

        });
        //透過projectId 篩選
        $(".selectProjectId").change(function () {
            var value = this.value;
            $.ajax({
                url: '@Url.Action("Project", "QueryForms")',
                type: 'Get',
                data: { projectId: value },
                success: function (response) {
                    if (response.success) {
                        let model = response.data;
                        $('table').DataTable().destroy();
                        $("tbody").empty();
                        model.findForm.forEach(function (item) {
                            var newRow = `<tr>
                                                                        <td>
                                                                            <a href="/FormDetails/Index/${item.formId}">
                                                                                ${item.formId}
                                                                            </a>
                                                                        </td>
                                                                        <td>${model.departments[item.departmentId]}</td>
                                                                        <td>${model.userName[item.userId]}</td>
                                                                        <td>${model.category[item.categoryId]}</td>
                                                                        <td>${model.projectName[item.projectId]}</td>
                                                                        <td>${model.userActivity[model.processNodes[item.processNodeId]]}</td>
                                                                        <td>${item.createdTime}</td>
                                                                    </tr>`;
                            $("tbody").append(newRow);

                        });
                        $('table').DataTable({
                            paging: true,
                            ordering: true,
                        });

                    } else {
                        alert(response.message);
                    }

                },
                error: function (response) {
                    alert("搜尋失敗")
                }
            })

        });

        //透過日期篩選
        $(".createddate").change(function () {
            var inputId = $(this).val();
            $.ajax({
                url: '@Url.Action("CreatDate", "QueryForms")',
                type: 'GET',
                data: { date: inputId },
                success: function (response) {
                    if (response.data) {
                        var model = response.data;
                        $('table').DataTable().destroy();
                        $("tbody").empty();
                        model.findForm.forEach(function (item) {
                            var newRow = `<tr>
                                                                                <td>
                                                                                    <a href="/FormDetails/Index/${item.formId}">
                                                                                        ${item.formId}
                                                                                    </a>
                                                                                </td>
                                                                                <td>${model.departments[item.departmentId]}</td>
                                                                                <td>${model.userName[item.userId]}</td>
                                                                                <td>${model.category[item.categoryId]}</td>
                                                                                <td>${model.projectName[item.projectId]}</td>
                                                                                <td>${model.userActivity[model.processNodes[item.processNodeId]]}</td>
                                                                                        <td>${item.createdTime}</td>
                                                                            </tr>`;
                            $("tbody").append(newRow);
                            $(".createddate").val("");

                        });
                        $('table').DataTable({
                            paging: true,
                            ordering: true,
                        });
                    } else {
                        alert(response.message || "連接失敗，請重新輸入");
                    }
                },
            });



        });


    </script>
}
