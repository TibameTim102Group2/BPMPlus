@using System.Text.Json
@using static BPMPlus.Controllers.BookingMeetingRoomController
@model MeetingRooms
@section Style
{
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">

    <style>
        .outside {
            padding: 20px;
            background-color: rgb(225, 239, 252);
            height: 100%;
        }

        .title {
            color: rgba(0, 81, 255, 0.884);
            margin-top: 20px;
            margin-bottom: 30px;
            margin-left: 30px;
            font-weight: bold;
        }

        .inside {
            margin-top: 30px;
            padding: 20px;
            background-color: rgb(225, 229, 252);
            border: 0.5px solid gainsboro;
            justify-content: space-between;
        }

        .form-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }

        label {
            margin: auto;
            display: inline;
            width: 200px;
            margin-right: 20PX;
            background-color: #458bfc;
            text-align: center;
            color: white;
            text-decoration: double;
            border-radius: 5%;
        }

        .btn-center{
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .submit-btn {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }



        .multiselect-container {
            width: 380px;
            position: relative;
            font-family: Arial, sans-serif;
        }

        .multiselect-input-container {
            position: relative;
            cursor: pointer;
        }

        .dropdown-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .multiselect-dropdown {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            background-color: white;
            z-index: 1000;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .multiselect-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .multiselect-item:hover {
            background-color: #f0f0f0;
        }

        .multiselect-item.department {
            font-weight: bold;
            background-color: #e9e9e9;
        }

        .multiselect-item.name {
            padding-left: 20px;
        }

        .selected-items {
            margin-top: 10px;
        }

        .selected-item {
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 4px 8px;
            background-color: #e0e0e0;
            border-radius: 16px;
            font-size: 14px;
        }

        .remove-item {
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
        }

        .search-input {
            width: calc(100% - 16px);
            margin: 8px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

    </style>
}

<!-- outside -->
<div class="outside">
    <h1 class="title">新增預約</h1>

    <!-- inside -->
    <div class="inside row">
        <div class="col-7">
            <table>
                預留table位子
            </table>
        </div>

        <div class="col-5" >
            <div class="form-group">
                <label>選擇會議室</label>
                <select class="form-control selectRoom" asp-items="ViewBag.MeetingRooms">
                    <option value="">-- 請選擇 --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="">可容納人數</label>
                <input class="form-control accommodation" Disabled />
            </div>

            <div class="form-group">
                <label for="">預約日期</label>
                <input type="date" min="@ViewBag.MinDate" class="form-control bookingDate" style="outline:none;" />
            </div>

            <div class="form-group">
                <label for="">開始時間</label>
                <select id="startTimeSelect" class="form-control timeSelect_startTime" style="outline:none;">
                </select>
            </div>

            <div class="form-group">
                <label for="">結束時間</label>
                <select id="endTimeSelect" class="form-control timeSelect_endTime" style="outline:none;">
                </select>
            </div>

            <div class="form-group">
                <label for="">預約人</label>
                <input type="text" class="form-control" value="@ViewBag.MeetingHost" Disabled />
            </div>

            <div class="form-group">
                <label for="">預約部門</label>
                <input type="text" class="form-control" value="@ViewBag.DepartmentName" Disabled />
            </div>

            <div class="form-group">
                <label for="">備註</label>
                <input type="text" class="form-control note">
            </div>

            <div class="form-group">
                <label for="">與會者</label>
                <div class="multiselect-container">
                    <div class="multiselect-input-container">
                        <input type="text" class="multiselect-input form-control members" placeholder="點擊加入與會者">
                        <span class="dropdown-arrow">▾</span>
                        <div class="multiselect-dropdown">
                            <input type="text" class="search-input" placeholder="搜尋">
                        </div>
                    </div>
                </div>
            </div>
            <div id="members" class="selected-items" style="margin-bottom:10px;"></div>

            <div class="btn-center">
                <button id="submitButton" class="btn btn-success">送出</button>
            </div>


        </div>

    </div>

</div>





@section Scripts
{
    <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

    <script>
        $(document).ready(function() {

            //加入與會者
            var colleagues = @Html.Raw(ViewBag.Employees);
            let selectedItems = [];
            let isDropdownOpen = false;

            function renderDropdown() {
                const $dropdown = $('.multiselect-dropdown');
                $dropdown.find('.multiselect-item').remove();
                $.each(colleagues, function (department, employees) {
                    $dropdown.append($('<div>').addClass('multiselect-item department').text(department));
                    $.each(employees, function (index, employee) {
                        // 假設 employee 是一個包含 name 和 id 的對象
                        if (!selectedItems.some(item => item.UserId === employee.UserId)) {
                            $('<div>')
                                .addClass('multiselect-item name')
                                .html(`${employee.UserId} <span class="employee-UserId">${employee.UserName}</span>`)
                                .on('click', function (e) {
                                    e.stopPropagation();
                                    selectItem(employee);
                                })
                                .appendTo($dropdown);
                        }
                    });
                });
            }

            function selectItem(employee) {
                selectedItems.push(employee);
                renderSelectedItems();
                $('.search-input').val('');
                renderDropdown();
            }

            function removeItem(employee) {
                selectedItems = selectedItems.filter(item => item.UserId !== employee.UserId);
                renderSelectedItems();
                renderDropdown();
            }

            function renderSelectedItems() {
                const $selectedItems = $('.selected-items');
                $selectedItems.empty();
                selectedItems.forEach(employee => {
                    $('<div>')
                        .addClass('selected-item')
                        .html(`${employee.UserId} ${employee.UserName} <span class="remove-item">✕</span>`)
                        .find('.remove-item')
                        .on('click', function (e) {
                            e.stopPropagation();
                            removeItem(employee);
                        })
                        .end()
                        .appendTo($selectedItems);
                });
            }

            function toggleDropdown() {
                isDropdownOpen = !isDropdownOpen;
                $('.multiselect-dropdown').toggle(isDropdownOpen);
                $('.dropdown-arrow').text(isDropdownOpen ? '▲' : '▼');
            }

            $('.multiselect-input-container').on('click', function (e) {
                e.stopPropagation();
                toggleDropdown();
                if (isDropdownOpen) {
                    renderDropdown();
                    $('.search-input').focus();
                }
            });

            $('.search-input').on('input', function () {
                const searchTerm = $(this).val().toLowerCase();
                $('.multiselect-item').each(function () {
                    const $item = $(this);
                    if ($item.hasClass('department')) {
                        $item.show();
                    } else {
                        const itemText = $item.text().toLowerCase();
                        if (itemText.includes(searchTerm)) {
                            $item.show();
                            $item.prevAll('.department:first').show();
                        } else {
                            $item.hide();
                        }
                    }
                });
            });

            $(document).on('click', function () {
                if (isDropdownOpen) {
                    toggleDropdown();
                }
            });

            renderDropdown();
            
            /* --------------------------------------------------------------------------------------------------------------------------- */

            //選擇會議室帶入可容納人數
            $(".selectRoom").change(function(){
                let meetingRoomId = this.value;
                $.ajax({
                    url: '@Url.Action("GetMeetingRoomInfo", "BookingMeetingRoom")',
                    type: 'GET',
                    data: { id: meetingRoomId },
                    success: function (response) {
                        var accommdation = response.data;
                        $(".accommodation").val(accommdation);
                    }
                });
            });

            //選擇預約日期確認預約狀況
            $(".bookingDate").change(function () {
                let meetingRoomId = $(".selectRoom").val();
                let bookingDate = this.value;

                $.ajax({
                    url: '@Url.Action("CheakMeetingRooms", "BookingMeetingRoom")',
                    type: 'GET',
                    data: {
                        RoomId: meetingRoomId,
                        BookingDate: bookingDate
                    },
                    success: function (response) {
                        // alert('response');
                        cheaking = response.data;

                        if (cheaking == "") {
                            let StartSelect = $("#startTimeSelect");
                            let EndSelect = $("#endTimeSelect")

                            function generateTimeOptions($select, startHour, endHour, interval, defaultText) {
                                $select.empty();

                                $select.append($('<option>', {
                                    value: '',
                                    text: defaultText
                                }));

                                for (var hour = startHour; hour <= endHour; hour++) {
                                    for (var minute = 0; minute < 60; minute += interval) {
                                        var time = padZero(hour) + ':' + padZero(minute);
                                        $select.append($('<option>', {
                                            value: time,
                                            text: time
                                        }));
                                    }
                                }
                            }

                            function padZero(num) {
                                return (num < 10 ? '0' : '') + num;
                            }

                            function updateEndTimeOptions() {
                                var startTime = StartSelect.val();
                                if (startTime) {
                                    var [startHour, startMinute] = startTime.split(':').map(Number);
                                    generateTimeOptions(EndSelect, startHour, 22, 60, '-- 請選擇結束時間 --');
                                    EndSelect.find('option').filter(function () {
                                        var [hour, minute] = $(this).val().split(':').map(Number);
                                        return hour < startHour || (hour === startHour && minute <= startMinute);
                                    }).prop('disabled', true);
                                } else {
                                    generateTimeOptions(EndSelect, 8, 22, 60, '-- 請先選擇開始時間 --');
                                    EndSelect.prop('disabled', true);
                                }
                            }

                            // 初始化時間選項
                            generateTimeOptions(StartSelect, 8, 22, 60, '-- 請選擇開始時間 --');
                            generateTimeOptions(EndSelect, 8, 22, 60, '-- 請先選擇結束時間 --');
                            EndSelect.prop('disabled', true);

                            // 當開始時間改變時更新結束時間選項
                            StartSelect.change(function () {
                                updateEndTimeOptions();
                                EndSelect.val('').prop('disabled', false);
                            });


                            // // 生成時間選項的函數
                            // function generateTimeOptions(startHour, endHour, interval) {
                            //     StartTimeSelect.empty(); // 清空現有選項

                            //     // 添加預設選項
                            //     StartTimeSelect.append($('<option>', {
                            //         value: '',
                            //         text: '-- 請選擇開始時間 --'
                            //     }));

                            //     // 生成時間選項
                            //     for (var hour = startHour; hour <= endHour; hour++) {
                            //         for (var minute = 0; minute < 60; minute += interval) {
                            //             var time = padZero(hour) + ':' + padZero(minute);
                            //             StartTimeSelect.append($('<option>', {
                            //                 value: time,
                            //                 text: time
                            //             }));
                            //         }
                            //     }
                            // }

                            // // 補零函數
                            // function padZero(num) {
                            //     return (num < 10 ? '0' : '') + num;
                            // }

                            // // 初始化時間選項（8:00 到 22:00，每小時一個選項）
                            // generateTimeOptions(8, 22, 60);

                        }
                        else {
                        // for (i = 0; i < cheaking.length; i++) {
                        //     var start = cheaking[i].startTime;
                        //     var end = cheaking[i].endTime;
                            
                        // }
                        // return cheaking;


                        }

                    }
                });


            });


            //點選開始時間後
            $(".startTime").change(function () {
                var startTime = this.value;


            });


            //結束時間不可早於開始時間
            $(".endTime").change(function () {
                
            });

            // submit
            $("#submitButton").click(function () {

                let room = $(".selectRoom").val();
                let bookingDate = $(".bookingDate").val();
                let startTime = $(".startTime").val();
                let endTime = $(".endTime").val();
                let note = $(".note").val();
                let members = [];

                $('#members .selected-item').each(function () {
                    // 取得中間的文字部分 (排除 <span>)
                    var text = $(this).contents().filter(function () {
                        return this.nodeType === 3; // 只選擇內文
                    }).text().trim();

                    // 取得UserId
                    var firstFourChars = text.substring(0, 4);
                    members.push(firstFourChars);
                });

                //檢查內容 不可為空
                if (room == "") {
                    alert('會議室不可為空!');
                    retuen;
                }
                if (bookingDate == "") {
                    alert('預約日期不可為空!');
                    return;
                }
                if (startTime == "") {
                    alert('開始時間不可為空!');
                    return;
                }
                if (endTime == "") {
                    alert('結束時間不可為空!');
                    return;
                }
                if (members == "") {
                    alert('與會者不可為空!');
                    return;
                }
                $.ajax({
                    url: '@Url.Action("SubmitBooking", "BookingMeetingRoom")',
                    type:'post',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        Room: room,
                        BookingDate: bookingDate,
                        StartTime: startTime,
                        EndTime: endTime,
                        Note: note,
                        Members: members
                    }),
                    success: function (response) { 
                        alert('預約成功');
                    },
                    error: function () { 
                        alert('error');
                    }
                });

            })


        });
    </script>
}