@model IEnumerable<BPMPlus.ViewModels.AdminQueryFormsViewModel>

@section Style {
    <link rel="stylesheet" href="~/font-awesome/css/all.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
    <style>
        .inputFormId input[type="text"] {
            border-bottom:1px solid #ced4da ;
            padding: 0.375rem 0.75rem; 
            font-size: 1rem; 
            background-color: #fff; 
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .createddate{
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.375rem 0.75rem;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #deleteSelected{
            width: 150px;
            height: 40px;
            margin-right:5px;
        }

        #recoverySelected{
            width: 150px;
            height: 40px;
        }

        #recoverySelected:disabled {
                opacity: 0.2;
        }

        .recovery-single:disabled{
            opacity: 0.2;
        }

    </style>
}

<div class="container-fluid">
    <div>
        <h1 style="margin-left:30px;">查詢工單</h1>
        <div class="row" >
            <section class="connectedSortable" style="padding: 50px 20px;">

                <div class="accordion" id="accordionExample">
                    <div id="mainpart" class="card" style="padding:20px">
                        <div class="row justify-content-between mb-3">

                            <div class="col-2 d-flex justify-content-center inputFormId">
                                <input type="text" class="btn fID" style="outline:none ;width:80%" placeholder="請填工單編號" />
                            </div>

                            <div class="col-2 d-flex justify-content-center">
                                <select name="DepartmentName" class="form-select selectbtn selectDepartment" asp-items="ViewBag.Department">
                                    <option value="" selected>全部部門</option>
                                </select>
                            </div>

                            <div class="col-2 d-flex justify-content-center">
                                <select name="Categories" class="form-select selectbtn selectCategoryId" asp-items="ViewBag.Category">
                                    <option value="" selected>全部需求項目</option>
                                </select>
                            </div>

                            <div class="col-2 d-flex justify-content-center">
                                <select name="ProjectName" class="form-select selectbtn selectProjectId" asp-items="ViewBag.Project">
                                    <option value="" selected>全部專案</option>
                                </select>
                            </div>

                            <div class="col-2 d-flex justify-content-center">
                                <select name="FormActive" class="form-select selectbtn selectFormActive" asp-items="ViewBag.FormActive">
                                    <option value="" selected>工單狀態</option>
                                </select>
                            </div>

                            <div class="col-2 d-flex justify-content-center">
                                <input type="date" class="btn  createddate" style="outline:none" min="2024-01-01" />
                            </div>

                            <div class="row justify-content-md-center mb-3 mt-5" style="text-align:center;">
                                <button id="deleteSelected" class="btn btn-danger">批次刪除</button>
                                <button id="recoverySelected" class="btn btn-success">批次復原</button>
                            </div>

                        </div>

                        <table id="formsTable" class="table table-striped table-hover" style="text-align:center">
                            <thead class="table-light table-bordered">
                                <tr>
                                    <th>全選<input type="checkbox" id="selectAll" style="margin-left:5px;" /></th>
                                    <th>工單號碼</th>
                                    <th>部門</th>
                                    <th>員工編號</th>
                                    <th>姓名</th>
                                    <th>需求項目</th>
                                    <th>專案項目</th>
                                    <th>流程進度</th>
                                    <th>更新時間</th>
                                    <th>工單狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>

                                @if (Model != null && Model.Any())
                                {
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td><input type="checkbox" class="form-checkbox" value="@item.FormId" /></td>
                                            <td>@item.FormId</td>
                                            <td>@item.DepartmentName</td>
                                            <td>@item.EmployeeId</td>
                                            <td>@item.UserName</td>
                                            <td>@item.Categories</td>
                                            <td>@item.ProjectName</td>
                                            <td>@item.UserActivityDescription</td>
                                            <td>@item.CreatedTime</td>
                                            <td>@item.FormActive</td>
                                            <td>
                                                <button class="btn btn-danger btn-sm delete-single" data-id="@item.FormId">刪除</button>
                                                <button class="btn btn-success btn-sm recovery-single" data-id="@item.FormId">復原</button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr></tr>
                                }


                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            // 設定datatable排版
            var table = $("#formsTable").DataTable({
                "dom": `<'row'<'col-sm-12 col-md-3'><'col-sm-12 col-md-3'f><'col-sm-12 col-md-3'l>>
                    <'row'<'col-sm-12'tr>>
                    <'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>`,
                "pageLength": 10,
                "order": [[7, "desc"]],
                "language": {
                    "lengthMenu": "顯示 _MENU_ 項結果",
                    "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                    "search": "搜尋:",
                    "paginate": {
                        "first": "第一頁",
                        "previous": "上一頁",
                        "next": "下一頁",
                        "last": "最後一頁"
                    }
                },
                // 自定義data實際需要欄列資料
                "columnDefs": [
                    {
                        "data": null,
                        "defaultContent": "<input type='checkbox' class='form-checkbox' />",
                        "targets": 0,
                        "orderable": false,
                        "className": "dt-body-center"
                    },
                    { "data": "formId", "targets": 1 },
                    { "data": "departmentName", "targets": 2 },
                    { "data": "employeeId", "targets": 3 },
                    { "data": "userName", "targets": 4 },
                    { "data": "categories", "targets": 5 },
                    { "data": "projectName", "targets": 6 },
                    { "data": "userActivityDescription", "targets": 7 },
                    { "data": "createdTime", "targets": 8 },
                    { "data": "formActive", "targets": 9 },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return "<button class='btn btn-danger btn-sm delete-single' data-id='" + row.formId + "'>刪除</button> " +
                                "<button class='btn btn-success btn-sm recovery-single' data-id='" + row.formId + "'>復原</button>";
                        },
                        "targets": 10,
                        "orderable": false
                    }
                ],
                "drawCallback": function (settings) {
                    bindDeleteEvents();
                }
            });

            // 檢查並更新按鈕狀態
            function updateButtonStatus() {
                table.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    var data = this.data();
                    var $row = $(this.node());
                    var $recoveryButton = $row.find('.recovery-single');

                    if (data.formActive === "存活") {
                        $recoveryButton.prop('disabled', true);
                    } else {
                        $recoveryButton.prop('disabled', false);
                    }
                });

                updateBatchRecoveryButtonStatus();
            }
            updateButtonStatus();

            // 更新批次復原按鈕狀態
            function updateBatchRecoveryButtonStatus() {
                var $batchRecoveryButton = $('#recoverySelected');
                var hasActiveChecked = false;

                table.$('input:checked').each(function () {
                    var rowData = table.row($(this).closest('tr')).data();
                    if (rowData.formActive === "存活") {
                        hasActiveChecked = true;
                        return false; 
                    }
                });

                $batchRecoveryButton.prop('disabled', hasActiveChecked);
            }

            // 當checkbox狀態改變時更新批次復原按鈕
            table.on('change', 'input[type="checkbox"]', function () {
                updateBatchRecoveryButtonStatus();
            });

            // 全選
            $('#selectAll').on("click", function () {
                $(".form-checkbox").prop("checked", this.checked);
                updateBatchRecoveryButtonStatus();
            });

            function bindDeleteEvents() {
                // 單筆刪除
                $(".delete-single").off("click").on("click", function () {
                    var formId = $(this).data("id");
                    var row = $(this).closest("tr");
                    if (confirm("確定要刪除此工單嗎？")) {
                        $.ajax({
                            url: `/AdminQueryForms/DeleteSingle`,
                            method: "POST",
                            data: { formId: formId },
                            success: function (data) {
                                if (data.success) {
                                    alert("成功 ! ");
                                    table.row(row).remove().draw(false);
                                } else {
                                    alert("刪除失敗：" + data.message);
                                }
                            }
                        });
                    }
                });
            }

            // 批次刪除
            $("#deleteSelected").on("click", function () {
                var selectedIds = [];
                table.$("input:checked").each(function () {
                    selectedIds.push(table.row($(this).closest("tr")).data().formId);
                });

                if (selectedIds.length === 0) {
                    alert("請選擇至少一筆資料進行刪除");
                    return;
                }

                if (confirm("確定要批次刪除這些工單嗎？")) {
                    $.ajax({
                        url: `/AdminQueryForms/DeleteMany`,
                        method: "POST",
                        data: { formIds: selectedIds },
                        traditional: true,
                        success: function (data) {
                            if (data.success) {
                                alert("成功 ! ");
                                $("#selectAll").prop("checked", false);
                                table.rows(table.$("input:checked").closest("tr")).remove().draw(false);
                            } else {
                                alert("批次刪除失敗：" + data.message);
                            }
                        }
                    });
                }
            });

            // 單筆復原
            $(".table").on("click", ".recovery-single", function () {
                var formId = $(this).data("id");
                if (confirm("確定要復原此工單嗎？")) {
                    $.ajax({
                        url: `/AdminQueryForms/RecoverySingle`,
                        method: "POST",
                        data: { formId: formId },
                        success: function (data) {
                            if (data.success) {
                                alert("成功 ! ");
                                location.reload();
                            } else {
                                alert("復原失敗：" + data.message);
                            }
                        }
                    });
                }
            });

            // 批次復原
            $("#recoverySelected").on("click", function () {
                var selectedIds = [];
                table.$('input:checked').each(function () {
                    selectedIds.push(table.row($(this).closest("tr")).data().formId);
                });

                if (selectedIds.length === 0) {
                    alert("請選擇至少一筆資料進行復原");
                    return;
                }

                if (confirm("確定要復原這些工單嗎？")) {
                    $.ajax({
                        url: `/AdminQueryForms/RecoveryMany`,
                        method: "POST",
                        data: { formIds: selectedIds },
                        success: function (data) {
                            if (data.success) {
                                alert("成功 ! ");
                                location.reload();
                            } else {
                                alert("批次復原失敗：" + data.message);
                            }
                        }
                    });
                }
            });



            // 工單搜尋
            $(".fID").on("keyup", function () {
                var formId = $(this).val();

                if (formId.trim() === "") {
                    loadAllForms();
                    return;
                }

                $.ajax({
                    url: `/AdminQueryForms/SearchFormId`,
                    type: "GET",
                    data: { id: formId },
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        }
                        else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            });

            // 部門搜尋
            $(".selectDepartment").on("change", function () {
                var departmentId = $(this).val();

                if (departmentId === "") {
                    loadAllForms();
                    return;
                }

                $.ajax({
                    url: `/AdminQueryForms/SearchDepartmentId`,
                    type: "GET",
                    data: { id: departmentId },
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        }
                        else if (data.message) {
                            alert(data.message);
                        }
                        else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            });

            // 需求類別搜尋
            $(".selectCategoryId").on("change", function () {
                var categoryId = $(this).val();

                if (categoryId === "") {
                    loadAllForms();
                    return;
                }

                $.ajax({
                    url: `/AdminQueryForms/SearchCategoryId`,
                    type: "GET",
                    data: { id: categoryId },
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        }
                        else if (data.message) {
                            alert(data.message);
                        }
                        else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            });

            // 專案搜尋
            $(".selectProjectId").on("change", function () {
                var projectId = $(this).val();

                if (projectId === "") {
                    loadAllForms();
                    return;
                }

                $.ajax({
                    url: `/AdminQueryForms/SearchProjectId`,
                    type: "GET",
                    data: { id: projectId },
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        }
                        else if (data.message) {
                            alert(data.message);
                        }
                        else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            });

            // 工單狀態搜尋
            $(".selectFormActive").on("change", function () {
                var formIsActive = $(this).val();

                if (formIsActive === "") {
                    loadAllForms();
                    return;
                }

                $.ajax({
                    url: `/AdminQueryForms/SearchFormIsActive`,
                    type: "GET",
                    data: { id: formIsActive },
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        }
                        else if (data.message) {
                            alert(data.message);
                        }
                        else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            });

            // 日期搜尋
            $(".createddate").on("change", function () {
                var selectDate = $(this).val();

                if (selectDate === "") {
                    loadAllForms();
                    return;
                }


                $.ajax({
                    url: `/AdminQueryForms/SearchDate`,
                    type: "GET",
                    data: { id: selectDate },
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        }
                        else if (data.message) {
                            alert(data.message);
                            loadAllForms();
                        }
                        else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            });


            // 全部工單
            function loadAllForms() {
                $.ajax({
                    url: `/AdminQueryForms/GetAll`,
                    type: "GET",
                    success: function (data) {
                        table.clear();
                        if (Array.isArray(data) && data.length > 0) {
                            table.rows.add(data).draw();
                            updateButtonStatus();
                        } else {
                            console.log("工單查詢失敗, 請稍後再試");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("工單查詢失敗, 請稍後再試 : " + error);
                    }
                });
            }
        });
    </script>
}
